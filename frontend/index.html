<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>InsightForge</title>

  <!-- Tailwind + Marked -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

  <style>
    .glass {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .tab-btn.active {
      border-bottom: 3px solid #4f46e5;
      color: #4f46e5;
    }
    pre {
      background: #1a1b26 !important;
      color: #a9b1d6 !important;
      padding: 1.25rem;
      border-radius: 0.75rem;
      overflow-x: auto;
      margin: 1.5rem 0;
      font-size: 0.875rem;
    }
    .markdown-content h1, .markdown-content h2, .markdown-content h3 {
      color: #1e1b4b;
      font-weight: 800;
      margin-top: 2rem;
    }
    .markdown-content p {
      color: #475569;
      line-height: 1.7;
      margin-bottom: 1rem;
    }
    .markdown-content ul {
      margin-left: 1.2rem;
      list-style: disc;
    }
    .markdown-content table {
      width: 100%;
      margin: 1.5rem 0;
      border-collapse: collapse;
      overflow-x: auto;
      font-size: 0.9rem;
    }
    .markdown-content table th,
    .markdown-content table td {
      border: 1px solid #e2e8f0;
      padding: 0.6rem;
      text-align: left;
    }
    .markdown-content table th {
      background: #f8fafc;
      font-weight: 800;
      color: #0f172a;
    }
    .markdown-content img {
      max-width: 100%;
      border-radius: 1rem;
      margin: 1.2rem 0;
      border: 1px solid #e2e8f0;
    }
  </style>
</head>

<body class="bg-slate-50 min-h-screen text-slate-900 font-sans">

  <!-- NAV -->
  <nav class="sticky top-0 z-50 glass border-b border-slate-200 px-8 py-4">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="bg-indigo-600 p-2 rounded-lg text-white">
          <i class="fa-solid fa-atom"></i>
        </div>
        <h1 class="text-xl font-bold tracking-tight text-indigo-950">
          InsightForge <span class="text-slate-400 font-light ml-1">v1.0</span>
        </h1>
      </div>

      <div id="status-chip" class="hidden flex items-center gap-2 px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold uppercase tracking-wider">
        <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div> Ready
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">

    <!-- SIDEBAR -->
    <aside class="lg:col-span-4 space-y-6">
      <div class="bg-white rounded-3xl shadow-xl border border-slate-100 p-8">
        <h2 class="text-xs font-black uppercase tracking-widest text-slate-400 mb-6">
          Data Ingestion Engine
        </h2>

        <!-- Drop Area -->
        <div id="drop-area" class="border-2 border-dashed border-slate-200 rounded-2xl p-10 text-center hover:border-indigo-400 transition-all cursor-pointer bg-slate-50/50 group">
          <input type="file" id="file-selector" class="hidden" accept=".csv,.xlsx,.xls,.json">
          <i class="fa-solid fa-file-export text-4xl text-slate-300 group-hover:text-indigo-500 mb-4 block"></i>
          <p class="text-sm font-bold text-slate-600" id="file-label">Select Source File</p>
          <p class="text-[10px] text-slate-400 mt-2 uppercase">
            Excel â€¢ CSV â€¢ JSON
          </p>
        </div>

        <!-- Intent Box -->
        <div class="mt-8">
          <label class="text-xs font-black uppercase tracking-widest text-slate-400 block mb-3">
            Analysis Intent
          </label>
          <textarea id="intent-box" rows="4"
            class="w-full rounded-2xl border-slate-200 text-sm p-4 focus:ring-4 focus:ring-indigo-50 focus:border-indigo-500 outline-none transition-all"
            placeholder="Describe the goal: 'Forecast Q4 demand' or 'Identify churn drivers'"></textarea>
        </div>

        <!-- Execute -->
        <button id="process-btn"
          class="w-full mt-8 bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-2xl shadow-xl shadow-indigo-100 transition-all active:scale-95 flex justify-center items-center gap-3">
          <i class="fa-solid fa-sparkles"></i> Execute Analysis
        </button>

        <!-- Smart Suggestions -->
        <div class="mt-8">
          <div class="flex items-center justify-between">
            <h3 class="text-xs font-black uppercase tracking-widest text-slate-400 mb-3">Smart Suggestions</h3>
            <label class="flex items-center gap-2 text-[10px] text-slate-400 font-bold">
              <input id="auto-run-toggle" type="checkbox" class="accent-indigo-600" checked/>
              Auto-run
            </label>
          </div>

          <div id="smart-suggestions" class="flex flex-wrap gap-2"></div>
          <p id="suggestions-empty" class="text-slate-400 italic text-xs mt-2 hidden">
            Suggestions will appear after your first analysis.
          </p>
        </div>

        <!-- Recent Reports -->
        <div class="mt-8">
          <h3 class="text-xs font-black uppercase tracking-widest text-slate-400 mb-3">Recent Reports</h3>
          <div id="recent-reports" class="space-y-3 text-xs text-slate-600">
            <p class="text-slate-400 italic">No reports yet.</p>
          </div>
        </div>
      </div>
    </aside>

    <!-- MAIN WORKSPACE -->
    <div class="lg:col-span-8">
      <div id="empty-state"
        class="bg-white rounded-3xl border border-slate-200 h-full min-h-[600px] flex flex-col items-center justify-center text-slate-300 space-y-6">
        <i class="fa-solid fa-vial-circle-check text-7xl opacity-10"></i>
        <p class="font-bold tracking-tight">System awaiting data ingestion...</p>
      </div>

      <div id="workspace" class="hidden space-y-6">

        <!-- Tabs Row -->
        <div class="flex items-center justify-between border-b border-slate-200 h-14">

          <div class="flex gap-8 text-xs font-black uppercase tracking-widest text-slate-400 h-full">
            <button onclick="view('analysis')" id="btn-analysis" class="tab-btn flex items-center h-full active">Narrative</button>
            <button onclick="view('code')" id="btn-code" class="tab-btn flex items-center h-full">Scripts & Logic</button>
            <button onclick="view('meta')" id="btn-meta" class="tab-btn flex items-center h-full">Extracted Schema</button>
            <button onclick="view('reports')" id="btn-reports" class="tab-btn flex items-center h-full">Reports</button>
          </div>

          <!-- Export Buttons -->
          <div id="download-buttons" class="hidden flex items-center gap-2">
            <a id="download-md"
               class="px-3 py-2 bg-slate-900 text-white rounded-xl text-xs font-black hover:bg-slate-800"
               download>
              Download .MD
            </a>
            <a id="download-html"
               class="px-3 py-2 bg-indigo-600 text-white rounded-xl text-xs font-black hover:bg-indigo-700"
               download>
              Download .HTML
            </a>
            <a id="download-pdf"
               class="px-3 py-2 bg-emerald-600 text-white rounded-xl text-xs font-black hover:bg-emerald-700 hidden"
               download>
              Download .PDF
            </a>
          </div>
        </div>

        <!-- Output Pane -->
        <div id="output-pane"
          class="bg-white rounded-3xl border border-slate-200 p-8 min-h-[400px] markdown-content prose max-w-none">
        </div>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="mt-12 border-t border-slate-200 py-8 text-center text-xs text-slate-400">
    <p class="font-semibold">InsightForge â€¢ Open Source Analytics Engine</p>
    <p class="mt-1">Developed by <span class="text-slate-600 font-bold">Oluwatosin Agbaakin</span> Â© 2026</p>
    <p class="mt-1">Licensed under the MIT License.</p>
  </footer>

  <!-- LOADER -->
  <div id="loader" class="fixed inset-0 bg-indigo-950/20 backdrop-blur-md hidden flex flex-col items-center justify-center z-[100]">
    <div class="bg-white p-10 rounded-3xl shadow-2xl flex flex-col items-center gap-6">
      <div class="w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
      <p class="font-black text-indigo-950 italic tracking-tight">Forging insights from your data...</p>
    </div>
  </div>

  <script>
    const sel = s => document.querySelector(s);

    let currentAnalysis = "";
    let currentMeta = "";
    let currentCode = "";
    let reportHistory = [];
    let currentExports = null;

    // File selection
    sel("#drop-area").onclick = () => sel("#file-selector").click();
    sel("#file-selector").onchange = e => {
      if (e.target.files.length) {
        sel("#file-label").innerText = e.target.files[0].name;
      }
    };

    function formatDate(dateStr) {
      try {
        return new Date(dateStr).toLocaleString();
      } catch {
        return dateStr;
      }
    }

    // ------------------------
    // REPORTS
    // ------------------------
    async function fetchReports() {
      try {
        const res = await fetch("/reports");
        const json = await res.json();
        if (json.status === "success") {
          reportHistory = json.reports || [];
          renderRecentReports();
        }
      } catch (e) {
        console.warn("Failed to fetch reports:", e.message);
      }
    }

    function renderRecentReports() {
      const container = sel("#recent-reports");
      container.innerHTML = "";

      if (!reportHistory.length) {
        container.innerHTML = `<p class="text-slate-400 italic">No reports yet.</p>`;
        return;
      }

      reportHistory.slice(0, 5).forEach(r => {
        const div = document.createElement("div");
        div.className =
          "p-3 rounded-xl border border-slate-200 bg-slate-50 flex justify-between items-start gap-3";

        div.innerHTML = `
          <div>
            <p class="font-black text-slate-800">${r.fileName}</p>
            <p class="text-[10px] text-slate-500">${formatDate(r.createdAt)}</p>
            <p class="text-[10px] text-slate-500">${r.rows || "?"} rows Ã— ${r.cols || "?"} cols</p>
          </div>
          <button onclick="view('reports')" class="text-indigo-600 text-xs font-black hover:underline">View</button>
        `;

        container.appendChild(div);
      });
    }

    function renderReportsPage() {
      if (!reportHistory.length) {
        sel("#output-pane").innerHTML =
          `<p class="text-slate-400 italic">No saved reports yet. Run an analysis to generate one.</p>`;
        return;
      }

      let html = `<h2 class="text-2xl font-black text-indigo-950 mb-4">Saved Reports</h2>`;
      html += `<p class="text-sm text-slate-500 mb-6">Your reports are stored locally. Download and share anytime.</p>`;

      reportHistory.slice(0, 10).forEach(r => {
        html += `
          <div class="border border-slate-200 rounded-2xl p-5 mb-4 bg-slate-50">
            <div class="flex justify-between items-start flex-wrap gap-3">
              <div>
                <h3 class="text-lg font-black text-slate-900">${r.fileName}</h3>
                <p class="text-xs text-slate-500">${formatDate(r.createdAt)}</p>
                <p class="text-xs text-slate-500 mt-1">${r.rows || "?"} rows Ã— ${r.cols || "?"} cols â€¢ Intent: ${r.intent || "(none)"}</p>
              </div>
              <div class="flex gap-2">
                <a class="px-3 py-2 bg-slate-900 text-white rounded-xl text-xs font-black hover:bg-slate-800"
                   href="${r.exports.markdown}" download>MD</a>
                <a class="px-3 py-2 bg-indigo-600 text-white rounded-xl text-xs font-black hover:bg-indigo-700"
                   href="${r.exports.html}" download>HTML</a>
                ${r.exports.pdf ? `
                  <a class="px-3 py-2 bg-emerald-600 text-white rounded-xl text-xs font-black hover:bg-emerald-700"
                     href="${r.exports.pdf}" download>PDF</a>` : ""}
              </div>
            </div>
          </div>
        `;
      });

      sel("#output-pane").innerHTML = html;
    }

    // ------------------------
    // SMART SUGGESTIONS
    // ------------------------
    function parseSuggestionsFromAnalysis(markdown) {
      const lines = markdown.split("\n");
      const suggestions = [];
      let inside = false;

      for (let line of lines) {
        if (line.includes("## ðŸ’¡ Smart Suggestions")) inside = true;
        if (inside && line.startsWith("## ") && !line.includes("Smart Suggestions")) break;

        if (inside) {
          const m = line.match(/^- (.+)$/);
          if (m) suggestions.push(m[1].trim());
        }
      }
      return suggestions;
    }

    function renderSuggestions(suggestions) {
      const container = sel("#smart-suggestions");
      container.innerHTML = "";

      if (!suggestions.length) {
        sel("#suggestions-empty").classList.remove("hidden");
        return;
      }

      sel("#suggestions-empty").classList.add("hidden");

      suggestions.slice(0, 10).forEach(s => {
        const btn = document.createElement("button");
        btn.className =
          "px-3 py-2 rounded-xl bg-indigo-50 text-indigo-700 text-xs font-black hover:bg-indigo-100 border border-indigo-100 transition-all";
        btn.textContent = s;

        btn.onclick = async () => {
          sel("#intent-box").value = s;
          if (sel("#auto-run-toggle").checked) {
            await start();
          }
        };

        container.appendChild(btn);
      });
    }

    // ------------------------
    // ANALYSIS
    // ------------------------
    async function start() {
      const file = sel("#file-selector").files[0];
      const context = sel("#intent-box").value;

      if (!file && !context) return alert("Source file or intent required");

      sel("#loader").classList.remove("hidden");

      const data = new FormData();
      if (file) data.append("file", file);
      data.append("context", context);

      try {
        const res = await fetch("/analyze", { method: "POST", body: data });
        const json = await res.json();

        if (json.status === "success") {
          currentAnalysis = json.analysis || "";
          currentMeta = json.metadata || "";
          currentCode = json.code || "";
          currentExports = json.exports || null;

          sel("#empty-state").classList.add("hidden");
          sel("#workspace").classList.remove("hidden");
          sel("#status-chip").classList.remove("hidden");

          // Export buttons
          if (currentExports) {
            sel("#download-buttons").classList.remove("hidden");
            if (currentExports.markdown) sel("#download-md").href = currentExports.markdown;
            if (currentExports.html) sel("#download-html").href = currentExports.html;

            if (currentExports.pdf) {
              sel("#download-pdf").classList.remove("hidden");
              sel("#download-pdf").href = currentExports.pdf;
            }
          }

          // Smart Suggestions extracted from analysis output
          renderSuggestions(parseSuggestionsFromAnalysis(currentAnalysis));

          // Refresh reports list
          await fetchReports();

          view("analysis");
        } else {
          alert(json.message || "Analysis failed.");
        }
      } catch (err) {
        alert("Connection error: " + err.message);
      } finally {
        sel("#loader").classList.add("hidden");
      }
    }

    function view(mode) {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      sel("#btn-" + mode).classList.add("active");

      if (mode === "analysis") {
        sel("#output-pane").innerHTML = marked.parse(currentAnalysis);
      } else if (mode === "code") {
        sel("#output-pane").innerHTML = marked.parse(currentCode);
      } else if (mode === "meta") {
        sel("#output-pane").innerHTML = `<pre>${currentMeta}</pre>`;
      } else if (mode === "reports") {
        renderReportsPage();
      }
    }

    sel("#process-btn").onclick = start;

    // Initialize reports on load
    fetchReports();
  </script>
</body>
</html>